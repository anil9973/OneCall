import R from"fastify";import T from"fastify-plugin";import I from"@fastify/env";var S={type:"object",required:["ELEVENLABS_API_KEY"],properties:{NODE_ENV:{type:"string",default:"development"},PORT:{type:"number",default:3e3},HOST:{type:"string",default:"0.0.0.0"},ELEVENLABS_API_KEY:{type:"string"},AGENT_BASE_ID:{type:"string"},AGENT_ECOMMERCE_ID:{type:"string"},AGENT_FINANCE_ID:{type:"string"},AGENT_ENTERTAINMENT_ID:{type:"string"},AGENT_EDUTECH_ID:{type:"string"},RATE_LIMIT_MAX:{type:"number",default:100},RATE_LIMIT_WINDOW:{type:"number",default:6e4},CORS_ORIGIN:{type:"string",default:"chrome-extension://*"}}},u=T(async s=>{await s.register(I,{schema:S,dotenv:!0})});import C from"fastify-plugin";async function E(s){s.decorate("authenticate",async function(e,t){try{if(!e.headers.authorization?.replace("Bearer ",""))return t.code(401).send({error:"No token provided"});if(!await e.jwtVerify())return t.code(401).send({error:"Invalid token"})}catch{return t.code(401).send({error:"Invalid token"})}}),s.decorate("authenticateOwner",async function(e,t){try{if(!e.headers.authorization?.replace("Bearer ",""))return t.code(401).send({error:"No token provided"});let n=await e.jwtVerify();if(!n||n.type!=="owner")return t.code(403).send({error:"Owner access required"});e.owner={id:n.ownerId,email:n.email,verified:n.verified,plan:n.plan}}catch{return t.code(401).send({error:"Invalid token"})}}),s.decorate("authenticateOptional",async function(e,t){try{if(!e.headers.authorization?.replace("Bearer ",""))return;let n=await e.jwtVerify();n&&n.type==="owner"&&(e.owner={id:n.ownerId,email:n.email,verified:n.verified,plan:n.plan})}catch{}})}var P=C(E,{name:"auth-plugin",dependencies:["@fastify/jwt"]});import k from"fastify-plugin";import x from"@fastify/cors";var m=k(async s=>{await s.register(x,{origin:(e,t)=>{let r=s.config.CORS_ORIGIN;if(e?.startsWith("chrome-extension://klchcjnlkbfoanbgplincdbmecfcpehh")){t(null,!0);return}t(new Error("Not allowed by CORS"),!1)},credentials:!0})});import{ElevenLabsClient as A}from"@elevenlabs/elevenlabs-js";var p=class{voices=[];lastFetch=0;cacheDuration=36e5;apiKey;constructor(e){this.apiKey=e}async fetchVoices(){let e=Date.now();if(this.voices.length>0&&e-this.lastFetch<this.cacheDuration)return this.voices;let t=new Headers({"xi-api-key":this.apiKey}),r=await fetch("https://api.elevenlabs.io/v1/voices",{headers:t});if(!r.ok)throw new Error("Failed to fetch voices");let n=await r.json();return this.voices=n.voices,this.lastFetch=e,this.voices}async select(e={}){let t=await this.fetchVoices();return t.filter(n=>{let o=n.labels||{};return!(e.gender&&o.gender?.toLowerCase()!==e.gender||e.age&&o.age?.toLowerCase()!==e.age||e.accent&&o.accent?.toLowerCase()!==e.accent||e.useCase&&o.use_case?.toLowerCase()!==e.useCase)})[0]??t[0]}async getById(e){return(await this.fetchVoices()).find(r=>r.voice_id===e)??null}async getConversational(){return(await this.fetchVoices()).filter(t=>t.labels?.use_case==="conversational")}};var l=class{agents;constructor(){this.agents={base:{id:process.env.AGENT_BASE_ID||"",name:"General Assistant",websiteType:"base",tools:["get_page_context","get_all_links","navigate_to_url","get_interactive_elements","highlight_element","click_element","scroll_page","escalate_to_human"]},shopping:{id:process.env.AGENT_SHOPPING_ID||"",name:"Shopping Assistant",websiteType:"shopping",tools:["get_page_context","navigate_to_url","click_element","get_order_list","track_shipment","add_to_cart","apply_coupon","find_product","escalate_to_human"]},finance:{id:process.env.AGENT_FINANCE_ID||"",name:"Finance Assistant",websiteType:"finance",tools:["get_page_context","navigate_to_url","check_authentication","get_account_balance","get_transactions","transfer_funds","pay_bill","escalate_to_human"]},entertainment:{id:process.env.AGENT_ENTERTAINMENT_ID||"",name:"Entertainment Assistant",websiteType:"entertainment",tools:["get_page_context","navigate_to_url","click_element","play_video","pause_video","search_content","add_to_playlist","get_recommendations"]},learning:{id:process.env.AGENT_LEARNING_ID||"",name:"Learning Assistant",websiteType:"learning",tools:["get_page_context","navigate_to_url","click_element","get_course_progress","submit_assignment","take_quiz","get_schedule","join_class"]},programming:{id:process.env.AGENT_PROGRAMMING_ID||"",name:"Developer Assistant",websiteType:"programming",tools:["get_page_context","get_all_links","navigate_to_url","knowledge_base_search","find_text_pattern","take_screenshot","copy_code_snippet"]},news:{id:process.env.AGENT_NEWS_ID||"",name:"News Assistant",websiteType:"news",tools:["get_page_context","navigate_to_url","get_all_links","scroll_page","take_screenshot","knowledge_base_search"]},research:{id:process.env.AGENT_RESEARCH_ID||"",name:"Research Assistant",websiteType:"research",tools:["get_page_context","navigate_to_url","knowledge_base_search","find_text_pattern","take_screenshot","get_all_links","scroll_page"]},"social-media":{id:process.env.AGENT_SOCIAL_MEDIA_ID||"",name:"Social Media Assistant",websiteType:"social-media",tools:["get_page_context","navigate_to_url","click_element","fill_input_field","scroll_page","take_screenshot"]},productivity:{id:process.env.AGENT_PRODUCTIVITY_ID||"",name:"Productivity Assistant",websiteType:"productivity",tools:["get_page_context","navigate_to_url","get_interactive_elements","click_element","fill_input_field","select_dropdown_option","create_task","update_status"]},documentation:{id:process.env.AGENT_DOCUMENTATION_ID||"",name:"Documentation Assistant",websiteType:"documentation",tools:["get_page_context","get_all_links","navigate_to_url","knowledge_base_search","find_text_pattern","scroll_page","take_screenshot"]}}}getAgent(e){return this.agents[e]??this.agents.base}getAllAgents(){return Object.values(this.agents)}};var i=class{client;voiceSelector;agentRegistry;apiKey;constructor(e){this.client=new A({apiKey:e,environment:"https://api.elevenlabs.io"}),this.voiceSelector=new p(e),this.agentRegistry=new l,this.apiKey=e}async getConversationToken(e="base",t,r){let n=this.agentRegistry.getAgent(e),o;r?o=await this.voiceSelector.getById(r)??await this.getDefaultVoice():t?o=await this.voiceSelector.select({gender:t.gender,age:t.ageGroup,accent:t.accent,useCase:"conversational"}):o=await this.getDefaultVoice();let c=new Request(`https://api.elevenlabs.io/v1/convai/conversation/token?agent_id=${n.id}`,{headers:{"xi-api-key":this.apiKey}}),a=await fetch(c);if(!a.ok){let w=await a.text();throw new Error(`Failed to get conversation token: ${w}`)}return{token:(await a.json()).token,agentId:n.id,voiceId:o.voice_id,voiceName:o.name,expiresIn:600}}async getVoices(){return this.voiceSelector.fetchVoices()}async getFilteredVoices(e){return(await this.voiceSelector.fetchVoices()).filter(r=>{let n=r.labels||{};return!(e.gender&&n.gender?.toLowerCase()!==e.gender||e.age&&n.age?.toLowerCase()!==e.age||e.accent&&n.accent?.toLowerCase()!==e.accent||e.useCase&&n.use_case?.toLowerCase()!==e.useCase)})}async getDefaultVoice(){return(await this.voiceSelector.getConversational())[0]??(await this.voiceSelector.fetchVoices())[0]}async registerTool(e){try{await this.client.conversationalAi.tools.create({toolConfig:e})}catch(t){throw console.error(`Failed to register tool ${e.name}:`,t),t}}async registerTools(e){let r=(await Promise.allSettled(e.map(n=>this.registerTool(n)))).filter(n=>n.status==="rejected");r.length>0&&console.warn(`${r.length} tools failed to register`)}getAgents(){return this.agentRegistry.getAllAgents()}getAgent(e){return this.agentRegistry.getAgent(e)}};var d=class{elevenLabsService;conversationService;constructor(e,t){this.elevenLabsService=new i(t),this.conversationService=e}async getToken(e,t){try{let{websiteType:r="base",userContext:n}=e.body,o=await this.elevenLabsService.getConversationToken(r,n);return t.code(200).send(o)}catch(r){return e.log.error(r,"Failed to generate conversation token"),t.code(500).send({error:"Failed to generate conversation token",message:r instanceof Error?r.message:"Unknown error"})}}async getAgents(e,t){try{let r=this.elevenLabsService.getAgents();return t.code(200).send({agents:r})}catch(r){return e.log.error(r,"Failed to get agents"),t.code(500).send({error:"Failed to get agents",message:r instanceof Error?r.message:"Unknown error"})}}async startConversation(e,t){let r=await this.conversationService.startConversation(e.body);return{id:r.id,sessionId:r.sessionId,status:r.status}}async addMessage(e,t){let{id:r}=e.params;try{return await this.conversationService.addMessage(r,e.body)}catch(n){let o=n instanceof Error?n.message:"Unknown error";return t.code(404).send({error:o})}}async endConversation(e,t){let{id:r}=e.params;return await this.conversationService.endConversation(r,e.body),{success:!0}}async getConversation(e,t){let{id:r}=e.params,n=e.owner?.id,o=await this.conversationService.getConversation(r);return o?n&&o.ownerId!==n?t.code(403).send({error:"Access denied"}):o:t.code(404).send({error:"Conversation not found"})}async listConversations(e,t){if(!e.owner?.id)return t.code(401).send({error:"Unauthorized"});let n={...e.query},c=(await this.conversationService.listConversations(n)).filter(a=>n.domain?a.domain===n.domain:!0);return{conversations:c,total:c.length}}async searchConversations(e,t){if(!e.owner?.id)return t.code(401).send({error:"Unauthorized"});let n=e.query,o=await this.conversationService.searchConversations(n);return{conversations:o,total:o.length}}};var g={type:"object",properties:{websiteType:{type:"string",enum:["shopping","finance","entertainment","learning","programming","news","research","social-media","productivity","documentation","base"]},userContext:{type:"object",properties:{gender:{type:"string",enum:["male","female","neutral"]},ageGroup:{type:"string",enum:["young","adult","senior"]},language:{type:"string"},country:{type:"string"}}}}},y={type:"object",required:["token","agentId","voiceId","expiresIn"],properties:{token:{type:"string"},agentId:{type:"string"},voiceId:{type:"string"},expiresIn:{type:"number"}}},f={body:{type:"object",required:["sessionId","domain","userId"],properties:{sessionId:{type:"string"},domain:{type:"string"},userId:{type:"string"},ownerId:{type:"string"},metadata:{type:"object"}}},response:{200:{type:"object",properties:{id:{type:"string"},sessionId:{type:"string"},status:{type:"string"}}}}},h={params:{type:"object",required:["id"],properties:{id:{type:"string"}}},body:{type:"object",required:["role","content","timestamp"],properties:{role:{type:"string",enum:["user","assistant","system"]},content:{type:"string",minLength:1},timestamp:{type:"number"},audioUrl:{type:"string",format:"uri"},duration:{type:"number"},toolCalls:{type:"array",items:{type:"string"}},metadata:{type:"object"}}},response:{200:{type:"object",properties:{id:{type:"string"},role:{type:"string"},content:{type:"string"},timestamp:{type:"number"}}}}},v={params:{type:"object",required:["id"],properties:{id:{type:"string"}}},body:{type:"object",properties:{resolution:{type:"string"},rating:{type:"number",minimum:1,maximum:5},duration:{type:"number",minimum:0}}},response:{200:{type:"object",properties:{success:{type:"boolean"}}}}};async function _(s){let e=new d(s.conversationService,s.config.ELEVENLABS_API_KEY);s.post("/token",{schema:{body:g,response:{200:y}},handler:e.getToken.bind(e)}),s.get("/agents",{handler:e.getAgents.bind(e)}),s.post("/start",{schema:f},e.startConversation),s.post("/:id/message",{schema:h},e.addMessage),s.post("/:id/end",{schema:v},e.endConversation)}async function b(){let s=R({logger:{level:process.env.NODE_ENV==="production"?"info":"debug"}});return await s.register(u),await s.register(m),await s.register(_,{prefix:"/api/conversation"}),s}async function q(){let s=await b();try{let e=s.config.PORT,t=s.config.HOST;await s.listen({port:e,host:t}),s.log.info(`\u{1F680} Server listening on http://${t}:${e}`),s.log.info(`\u{1F4CA} Environment: ${s.config.NODE_ENV}`)}catch(e){s.log.error(e),process.exit(1)}}q();
